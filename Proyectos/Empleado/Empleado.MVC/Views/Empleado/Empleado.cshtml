<html>
<head>
    <title>Empleado - Editar</title>
</head>
<body>
<h1 id="titulo"></h1>
<style>
    table{
        width: 100%;
    }
</style>
<form id="formulario" method="post">
<fieldset>
    <legend>Información básica</legend>
    <br><br>
    <table id="datos">
        <tr>
            <td><label for="nombre">Nombre: </label></td>               
            <td><input type="text" name="nombre" id="nombre"></td>
            <td><label for="apellidop">Apellido Paterno: </label></td>
            <td><input type="text" name="paterno" id="paterno"></td>
            <td><label for="apellidom">Apellido Materno: </label></td>
            <td><input type="text" name="materno" id="materno"></td>
        </tr>
    </table>
    <br><br>
</fieldset>

<fieldset>
    <legend>Datos personales</legend>
    <br><br>
    <table>
        <tr>
            <td><label for="sexo">Sexo:</label></td>
            <td>
                <select id="slcsexo" name="slcsexo">
                    <option value="seleccionasexo" selected="selected">- Selecciona -</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                </select>
            </td>

            <td><label for="curp">CURP:</label></td>
            <td><input type="text" name="curp" id="curp" maxlength="18"></td>

            <td><label for="fechanacimiento">Fecha de nacimiento:</label></td>
            <td><input type="date" name="nacimiento" id="nacimiento" value=""></td>
            </td>
        </tr>
        <tr>
            <td><label for="nacionalidad">Nacionalidad:</label></td>
            <td>
                <select name="slcnacionalidad" id="slcnacionalidad">
                    <option value="seleccionaN" selected="selected">- Selecciona -</option>
                    <option value="Mexicana">Mexicana</option>
                    <option value="Extranjera">Extranjera</option>
                </select>
            </td>
            <td><label for="rfc">RFC:</label></td>
            <td><input type="text" name="rfc" id="rfc"></td>
            <td><label for="nns">NSS:</label></td>
            <td><input type="text" name="nss" id="nss"></td>
        </tr>
        <tr>
            <td><label for="telefono">Telefono:</label></td>
            <td><input type="text" name="telefono" id="telefono"></td>
            <td><label for="correo">Correo Electronico:</label></td>
            <td><input type="text" name="correo" id="correo"></td>
        </tr>
    </table>
    <br><br>
</fieldset>

<fieldset>
    <legend>Domicilio</legend>
    <br><br>
    <table>
        <tr>
            <td><label for="calle">Calle:</label></td>
            <td><input type="text" name="calle" id="calle"></td>
            <td><label for="numeroi">Numero interior:</label></td>
            <td><input type="text" name="numeroi" id="numeroi"></td>
            <td><label for="numeroe">Numero exterior:</label></td>
            <td><input type="text" name="numeroe" id="numeroe"></td>
        </tr>
        <tr>
            <td><label for="colonia">Colonia:</label></td>
            <td><input type="text" name="colonia" id="colonia"></td>
            <td><label for="municipio">Municipio:</label></td>
            <td><input type="text" name="municipio" id="municipio"></td>
            <td><label for="estado">Estado:</label></td>
            <td>
                <select name="slcestado" id="slcestado">
                    <option value="seleccionaN" selected="selected">- Selecciona -</option>
                    <option value="Aguas Calientes">Aguas Calientes</option>
                    <option value="Baja California Norte">Baja California Norte</option>
                    <option value="Baja California Sur">Baja California Sur</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label for="cp">Codigo Postal:</label></td>
            <td><input type="text" name="cp" id="cp"></input></td>
        </tr>
    </table>
    <br><br>
</fieldset>
<fieldset>
    <legend>Datos Laborales</legend>
    <br><br>
    <table>
        <tr>
            <td><label for="puesto">Puesto:</label></td>
            <td>
                <select name="slcpuesto" id="slcpuesto">
                    <option value="selecciona" selected="selected">- Selecciona -</option>
                    <option value="DIRECTOR GENERAL">Director General</option>
                    <option value="DIRECTOR DE OPERACIONES">Director de Operaciones</option>
                    <option value="DESARROLLO MOVÍL">Desarrollador Movil</option>
                    <option value="DESARROLLADOR FRONTEND">Desarrollador FrontEnd</option>
                    <option value="DESARROLLADOR BACKEND">Desarrollador BackEnd</option>
                    <option value="DESARROLLADOR FULLSTACK">Desarrollador FullStack</option>
                </select>
            </td>
            <td><label for="fechaingreso">Fecha de Ingreso:</label></td>
            <td><input type="date" name="fechaingreso" id="fechaingreso"></td>
            <td><label for="salario">Salario Diario:</label></td>
            <td><input type="text" name="salario" id="salario"></td>
        </tr>
        <tr>
            <td><label for="horario">Horario:</label></td>
            <td>
                <select name="slchorario" id="slchorario">
                    <option value="selecciona">- Selecciona -</option>
                    <option value="Lunes a Viernes de 08:00 - 17:00">L-V 8 - 5</option>
                    <option value="Lunes a Viernes de 08:00 - 15:00 y Sabado de 08:00 - 12:00">L-V 8 - 3 y S 8 - 12</option>
                    <option value="Lunes a Viernes de 15:00 - 22:00">L-V 3 - 10</option>
                </select>
            </td>
            <td><label for="totalf">Total Faltas:</label></td>
            <td><input type="text" name="totalf" id="totalf"></td>
        </tr>
    </table>
    <br><br>
</fieldset>

<button type="button" id="bttnGuardar" href='javascript:guardar();' onClick="guardar();">Guardar</button>
<button id="bttnCerrar" type="button" onclick="window.location.href='/Empleado/Listado'">Cerrar</button>
</form>

<script>
    var accion = "";
    var idEmpleado = 0;
    function obtenerPeticion(){
        // 1.- Inicio
        // 2.- Obteneer los elementos de html
        // 3.- Obtener los valores de los elementos html
        const nombre = document.getElementById("nombre").value;
        const paterno = document.getElementById("paterno").value;
        const materno = document.getElementById("materno").value;
        const sexo = document.getElementById("slcsexo").value;
        const curp = document.getElementById("curp").value;
        const nacimiento = document.getElementById("nacimiento").value;
        const nacionalidad = document.getElementById("slcnacionalidad").value;
        const rfc = document.getElementById("rfc").value;
        const nss = document.getElementById("nss").value;
        const telefono = document.getElementById("telefono").value;
        const correo = document.getElementById("correo").value;
        const calle = document.getElementById("calle").value;
        const numeroi = document.getElementById("numeroi").value;
        const numeroe = document.getElementById("numeroe").value;
        const colonia = document.getElementById("colonia").value;
        const municipio = document.getElementById("municipio").value;
        const estado = document.getElementById("slcestado").value;
        const cp = document.getElementById("cp").value;
        const puesto = document.getElementById("slcpuesto").value;
        const fechaingreso = document.getElementById("fechaingreso").value;
        const salario = document.getElementById("salario").value;
        const horario = document.getElementById("slchorario").value;
        const totalFaltas = document.getElementById("totalf").value;
        // 4.- Crear la petición (JSON) a realizar
        var raw = JSON.stringify({
        "idEmpleado": idEmpleado,
        "rfc": rfc,
        "puesto": puesto,
        "fechadeIngreso": fechaingreso,
        "salarioDiario": salario,
        "nss": nss,
        "horario": horario,
        "totalFaltas": totalFaltas,
        "activo": true,
        "nombre": nombre,
        "apellidoPaterno": paterno,
        "apellidoMaterno": materno,
        "sexo": sexo,
        "curp": curp,
        "telefono": telefono,
        "correoElectronico": correo,
        "fechaNacimiento": nacimiento,
        "nacionalidad": nacionalidad,
        "direccion": {
            "calle": calle,
            "numeroInterior": numeroi,
            "numeroExterior": numeroe,
            "colonia": colonia,
            "municipio": municipio,
            "estado": estado,
            "codigoPostal": cp,
        } 
        });
        console.log(raw)
        return raw;
        // 5.- Fin
    }

    function guardar(){

        // 1.- Inicio
        // 2.- Obtener la acción de EDITAR o REGISTRAR
        if(accion == "EDITAR")
        {
            console.log("ACCION: EDITAR")
            // 3.- Si es EDITAR
            // 3.1.- Obtener la petición a traves del metodo obtenerPetición
            var raw = obtenerPeticion();
            // 3.2.- Crear y realizar la petición al servicio de editar
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var requestOptions = {
                method: 'PUT',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
                };

                fetch("https://localhost:5003/empleados", requestOptions)
                .then(response => {
                    if (response.status == 200){
                        // 3.3.- Si se guardo correctamente, mandar el mensaje de que los datos se guardaron correctamente
                        alert("Los datos se guardaron correctamente");
                    }else{
                        // 3.4.- Si no se guardo correctamente, mandar el mensaje de que los datos no se guardaron correctamente
                        alert("Los datos no se guardaron correctamente, contacte al administrador");
                        console.log("Los datos no se guardaron correctamente", response);
                    }
                })
                .catch(error => {
                    // 3.5.- Si no se pudo realizar la conexión al servicio, mandar mensaje de que no se pudo conectar al servicio
                    alert("No se pudo realizar la acción, contacte al administrador");
                    console.log("No se pudo realizar la acción", response);
                });
        }
        else if(accion == "REGISTRO")
        {
            // 4.- Si es REGISTRO
            // 4.1.- Obtener la petición a traves del metodo obtener
            var raw = obtenerPeticion();
            // 4.2.- Crear y realizar la petición al servicio de registrar
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");
            
            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
                };
                
                fetch("https://localhost:5003/empleados", requestOptions)
                .then(response => {
                    if (response.status == 200){
                        // 4.3.- Si se guardo correctamente, mandar el mensaje de que los datos se guardaron correctamente
                        alert("Los datos se guardaron correctamente");
                    }else{
                        // 4.4.- Si no se guardo correctamente, mandar el mensaje de que los datos no se guardaron correctamente
                        alert("Los datos no se guardaron correctamente, contacte al administrador");
                        console.log("Los datos no se guardaron correctamente", response);
                    }
                })
                .catch(error => {
                    // 4.5.- Si no se pudo realizar la conexión al servicio, mandar mensaje de que no se pudo conectar al servicio
                    alert("No se pudo realizar la acción, contacte al administrador");
                    console.log("No se pudo realizar la acción", response);
                });
        }
        else
        {
            // 5.- Si no es EDITAR y tampoco REGISTRO
            // 5.1.- Mandar un mensaje de error de acción no valida
            alert("Acción no valida");
        }
        // 6.- Fin
    }

    window.onload = function() {
        // 1.- Inicio
        // 2.- Obtener el path de la url
        const path = window.location.pathname;
        // 3.- Obtener la acción a realizar con la url (REGISTRAR o EDITAR)
        const arreglo = path.split("/");
        const accionURL = arreglo[2];
        // 4.- Si es EDITAR, cargar información del empleado, registrar la acción de EDITAR
        if(accionURL.toUpperCase() == "EDITAR"){
            // 4.1.- Registrar la acción de EDITAR como variable global
            accion = "EDITAR";
            // 4.2.- Actualizar el titulo a Edicion de Empleado
            const titulo = document.getElementById("titulo");
            titulo.innerHTML = 'Edición de empleado';
            // 4.3.- Cargar la información del empleado
            cargar(false);
        }
        else if(accionURL.toUpperCase() == "REGISTRO" ){
            // 5.- Si es REGISTRAR
            // 5.1.- Registrar la acción de REGISTRAR como variable global
            accion = "REGISTRO";
            // 5.2.- Actualizar el titulo de Alta de empleados
            const titulo = document.getElementById("titulo");
            titulo.innerHTML = 'Alta de empleado';
        }else if(accionURL.toUpperCase() == "CONSULTAR"){
            accion = "CONSULTAR";
            const titulo = document.getElementById("titulo");
            titulo.innerHTML = 'Consulta de empleado';
            cargar(true);
        }else {
            // 6.- Si la opción es diferente de EDITAR y REGISTRAR, mnadar mensaje de acción no valida
            alert("Acción no valida");
        }
        // 6.- Fin
    };

    function obtenerFecha(fecha) {
        fecha = fecha.substring(0,10);
        return fecha;
    }

    function cargar(visible){
        // 1.- Inicio
        // 2.- Obtener el id del empleado
        const path = window.location.pathname;
        const arreglo = path.split("/");
        const idEmpleadoURL = arreglo[3];
        idEmpleado = idEmpleadoURL;
        // 3.- Consumir el servicio de obtener empleado por el id
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        var url = "https://localhost:5003/empleados/" + idEmpleadoURL;
            fetch(url, requestOptions)
            .then(response => {
                if(response.status == 200){
                    response.json().then(empleado => {
                        // 3.1.- Si el servicio me regresa el empleado, pintarlo en pantalla
                        const btnGuardar = document.getElementById("bttnGuardar");
                        btnGuardar.disabled= visible;
                        // 3.1.1.- Obtener los elementos html
                        const nombre = document.getElementById("nombre");
                        const paterno = document.getElementById("paterno");
                        const materno = document.getElementById("materno");
                        const sexo = document.getElementById("slcsexo");
                        const curp = document.getElementById("curp");
                        const nacimiento = document.getElementById("nacimiento");
                        const nacionalidad = document.getElementById("slcnacionalidad");
                        const rfc = document.getElementById("rfc");
                        const nss = document.getElementById("nss");
                        const telefono = document.getElementById("telefono");
                        const correo = document.getElementById("correo");
                        const calle = document.getElementById("calle");
                        const numeroi = document.getElementById("numeroi");
                        const numeroe = document.getElementById("numeroe");
                        const colonia = document.getElementById("colonia");
                        const municipio = document.getElementById("municipio");
                        const estado = document.getElementById("slcestado");
                        const cp = document.getElementById("cp");
                        const puesto = document.getElementById("slcpuesto");
                        const ingreso = document.getElementById("fechaingreso");
                        const salario = document.getElementById("salario");
                        const horario = document.getElementById("slchorario");
                        const totalFaltas = document.getElementById("totalf");
                        // 3.1.2.- Pintar las propiedades en los elementos html
                        nombre.value = empleado.nombre;
                        nombre.disabled= visible;

                        paterno.value = empleado.apellidoPaterno;
                        paterno.disabled= visible;

                        materno.value = empleado.apellidoMaterno;
                        materno.disabled= visible;

                        sexo.value = empleado.sexo;
                        sexo.disabled= visible;

                        curp.value = empleado.curp;
                        curp.disabled= visible;

                        nacimiento.value = obtenerFecha(empleado.fechaNacimiento);
                        nacimiento.disabled= visible;

                        nacionalidad.value = empleado.nacionalidad;
                        nacionalidad.disabled= visible;

                        rfc.value = empleado.rfc;
                        rfc.disabled= visible;

                        nss.value = empleado.nss;
                        nss.disabled= visible;

                        telefono.value = empleado.telefono;
                        telefono.disabled= visible;

                        correo.value = empleado.correoElectronico;
                        correo.disabled= visible;

                        calle.value = empleado.direccion.calle;
                        calle.disabled= visible;

                        numeroi.value = empleado.direccion.numeroInterior;
                        numeroi.disabled= visible;

                        numeroe.value = empleado.direccion.numeroExterior;
                        numeroe.disabled= visible;

                        colonia.value = empleado.direccion.colonia;
                        colonia.disabled= visible;

                        municipio.value = empleado.direccion.municipio;
                        municipio.disabled= visible;

                        estado.value = empleado.direccion.estado;
                        estado.disabled= visible;

                        cp.value = empleado.direccion.codigoPostal;
                        cp.disabled= visible;

                        puesto.value = empleado.puesto;
                        puesto.disabled= visible;

                        ingreso.value = obtenerFecha(empleado.fechadeIngreso);
                        ingreso.disabled= visible;

                        salario.value = empleado.salarioDiario;
                        salario.disabled= visible;

                        horario.value = empleado.horario;
                        horario.disabled= visible;

                        totalFaltas.value = empleado.totalFaltas;
                        totalFaltas.disabled= visible;
                    })
                }else{
                // 3.2.- Si el servicio no regresa al empleado, pinta mensaje no se encontro el empleado
                alert("No se encontro el empleado, contactar al administrador");
                console.log("No se encontro el empleado, contactar al administrador", response)
                }
            })
            .catch(error => {
            // 3.3.- Si hubo un error, mostrar el mensaje de error en pantalla
            alert("Ocurrio un error, contactar al administrador")
            console.log("Ocurrio un error, contactar al administrador", error)
            });
        // 4.- Fin
    }
</script>
</body>
</html>